<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#e74c3c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>POS MUNDOLAVADORAS</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary: #e74c3c;
            --primary-dark: #c0392b;
            --secondary: #667eea;
            --success: #2ecc71;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --white: #ffffff;
            --gray-light: #f8f9fa;
            --text-dark: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-dark);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                z-index: 1000;
                max-width: 100% !important;
                height: 60px;
                overflow: hidden;
                transition: height 0.3s ease;
                border-radius: 20px 20px 0 0 !important;
                box-shadow: 0 -10px 30px rgba(0,0,0,0.2) !important;
            }
            .sidebar.active {
                height: 80vh;
                overflow-y: auto;
            }
            .main-content {
                padding-bottom: 70px;
            }
            .cart-toggle {
                display: flex !important;
            }
        }

        .main-content, .sidebar {
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 { font-size: 20px; }
        .header p { font-size: 12px; opacity: 0.9; }

        .search-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="search"], input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 16px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        .btn-primary { background: var(--secondary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--primary); }

        .scanner-btn {
            background: #f1c40f;
            color: #000;
        }

        #qr-reader {
            width: 100%;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            padding: 20px;
        }

        .product-card {
            border: 1px solid #eee;
            border-radius: 15px;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
        }

        .product-card img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .product-card h3 {
            font-size: 14px;
            margin-bottom: 5px;
            height: 40px;
            overflow: hidden;
        }

        .product-price {
            font-weight: bold;
            color: var(--success);
            font-size: 16px;
            margin-bottom: 5px;
        }

        .business-badge {
            background: #f39c12;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 5px;
            display: inline-block;
            margin-bottom: 10px;
        }

        /* Sidebar / Cart Styles */
        .sidebar { padding: 0; display: flex; flex-direction: column; }
        .sidebar-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-toggle {
            display: none;
            width: 100%;
            height: 60px;
            background: var(--primary);
            color: white;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }

        #cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 10px;
            align-items: center;
            padding-bottom: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .cart-item-name { font-size: 12px; font-weight: bold; }
        .cart-item-qty { width: 40px; padding: 5px; border-radius: 5px; border: 1px solid #eee; }
        .cart-item-price { font-size: 12px; }

        .cart-footer {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* Loading Spinner */
        .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Receipt Styles */
        @media print {
            body * { visibility: hidden; }
            #receipt, #receipt * { visibility: visible; }
            #receipt {
                position: absolute;
                left: 0;
                top: 0;
                width: 80mm;
                padding: 5mm;
                font-family: 'Courier New', monospace;
                color: black;
            }
            .no-print { display: none; }
        }
        
        #receipt { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <main class="main-content">
            <div class="header">
                <h1>POS MUNDOLAVADORAS</h1>
                <p>Buscador e Inventario en Tiempo Real</p>
            </div>

            <section class="search-section">
                <div class="search-box">
                    <input type="search" id="search" placeholder="Buscar por nombre o SKU...">
                    <button class="btn btn-primary" id="search-btn">üîç</button>
                    <button class="btn scanner-btn" id="toggle-scanner">üì∑</button>
                </div>
                <div id="qr-reader"></div>
                <div id="camera-status"></div>
            </section>

            <div class="loader" id="loader">
                <div class="spinner"></div>
                <p>Buscando...</p>
            </div>

            <section id="productos" class="products-grid">
                <!-- Productos se cargan aqu√≠ -->
            </section>
        </main>

        <aside class="sidebar" id="sidebar">
            <div class="cart-toggle" id="cart-toggle">
                üõí Ver Carrito (<span id="cart-count">0</span>) - <span id="cart-total-top">$0</span>
            </div>
            <div class="sidebar-header">
                <h2>Tu Carrito</h2>
                <button class="btn btn-danger" onclick="clearCart()">Vaciar</button>
            </div>
            <div id="cart-items">
                <!-- Items del carrito -->
            </div>
            <div class="cart-footer">
                <div class="total-row">
                    <span>Total:</span>
                    <span id="total-price">$0</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" style="flex: 1;" id="checkout-btn">PAGAR</button>
                    <button class="btn btn-primary" id="print-btn">üñ®Ô∏è</button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Ticket Template -->
    <div id="receipt">
        <div style="text-align: center; margin-bottom: 10px;">
            <img src="imagenes/logo.png" style="width: 50mm; filter: grayscale(1);">
            <h3>MUNDOLAVADORAS</h3>
            <p>Calle 10#6-29 sucre</p>
            <p>Tel 3186967164</p>
            <p id="receipt-date"></p>
        </div>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px dashed black;">
                    <th align="left">Prod</th>
                    <th align="center">Cant</th>
                    <th align="right">Total</th>
                </tr>
            </thead>
            <tbody id="receipt-body"></tbody>
        </table>
        <div style="border-top: 1px dashed black; margin-top: 5px; padding-top: 5px;">
            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                <span>TOTAL:</span>
                <span id="receipt-total"></span>
            </div>
        </div>
        <div style="text-align: center; margin-top: 10px; font-size: 10px;">
            <p>Art√≠culos el√©ctricos no tienen garant√≠a</p>
            <p>¬°Gracias por su compra!</p>
        </div>
    </div>

    <template id="producto-template">
        <article class="product-card">
            <img class="image" src="" alt="">
            <div class="business-badge" style="display: none;">Precio Negocio</div>
            <h3 class="name"></h3>
            <p class="product-price"></p>
            <p class="stock" style="font-size: 10px; color: #7f8c8d;"></p>
            <button class="btn btn-success add-to-cart" style="width: 100%; margin-top: auto;">Agregar</button>
        </article>
    </template>

    <template id="cart-item-template">
        <div class="cart-item">
            <span class="cart-item-name"></span>
            <input type="number" class="cart-item-qty" min="1">
            <span class="cart-item-price"></span>
            <button class="btn btn-danger remove-item" style="padding: 5px 10px;">x</button>
        </div>
    </template>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        // CONFIGURACIONES
        const STORE_MAIN = {
            url: 'https://mundolavadoras.com/wp-json/wc/v3/products',
            key: 'ck_ac71f77112971d39f3e349dd4a2d0ffbafb21f7a',
            secret: 'cs_fb4fea0b0b698bc83365c2fccb73720003f8da4a'
        };
        const STORE_BIZ = {
            url: 'https://cerebroelectronics.com/wp-json/wc/v3/products',
            key: 'ck_a4223282e3089bd6f9cf0038fc858baf06719436',
            secret: 'cs_8c532ec7decabb40e9a8989bcdcb75ac381f525a'
        };

        const d = document,
            $productos = d.getElementById("productos"),
            $loader = d.getElementById("loader"),
            $cartItems = d.getElementById("cart-items"),
            $totalPrice = d.getElementById("total-price"),
            $cartCount = d.getElementById("cart-count"),
            $cartTotalTop = d.getElementById("cart-total-top"),
            $sidebar = d.getElementById("sidebar");

        let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        let productosCache = [];
        let html5QrCode = null;

        function formatPrice(number) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(number);
        }

        // FETCH PRODUCTOS
        async function fetchProducts(query) {
            $loader.style.display = "block";
            $productos.innerHTML = "";
            try {
                // Intentar por b√∫squeda general
                let api = `${STORE_MAIN.url}?search=${encodeURIComponent(query)}&consumer_key=${STORE_MAIN.key}&consumer_secret=${STORE_MAIN.secret}`;
                let res = await fetch(api);
                let products = await res.json();

                // Si no hay resultados, intentar por SKU exacto
                if (products.length === 0) {
                    api = `${STORE_MAIN.url}?sku=${encodeURIComponent(query)}&consumer_key=${STORE_MAIN.key}&consumer_secret=${STORE_MAIN.secret}`;
                    res = await fetch(api);
                    products = await res.json();
                }

                productosCache = products;
                renderProducts(products);
            } catch (err) {
                console.error(err);
                $productos.innerHTML = "<h3>Error al cargar productos</h3>";
            } finally {
                $loader.style.display = "none";
            }
        }

        async function getBusinessPrice(sku) {
            try {
                const api = `${STORE_BIZ.url}?sku=${encodeURIComponent(sku)}&consumer_key=${STORE_BIZ.key}&consumer_secret=${STORE_BIZ.secret}`;
                const res = await fetch(api);
                const products = await res.json();
                if (products.length > 0) {
                    const p = products[0];
                    let bizPrice = null;
                    if (p.meta_data) {
                        const meta = p.meta_data.find(m => m.key === '_precio_cliente_negocio');
                        if (meta) bizPrice = parseFloat(meta.value);
                    }
                    return bizPrice || parseFloat(p.price);
                }
            } catch (e) { return null; }
            return null;
        }

        async function renderProducts(products) {
            const template = d.getElementById("producto-template").content;
            const fragment = d.createDocumentFragment();

            for (const p of products) {
                const clone = d.importNode(template, true);
                clone.querySelector(".name").textContent = p.name;
                clone.querySelector(".product-price").textContent = formatPrice(parseFloat(p.price));
                clone.querySelector(".stock").textContent = `Stock: ${p.stock_quantity || 0}`;
                clone.querySelector(".image").src = p.images.length ? p.images[0].src : 'imagenes/logo.png';
                
                const addBtn = clone.querySelector(".add-to-cart");
                addBtn.onclick = () => addToCart(p);

                // Verificar precio de negocio de forma as√≠ncrona
                getBusinessPrice(p.sku).then(bizPrice => {
                    if (bizPrice && bizPrice < parseFloat(p.price)) {
                        const card = Array.from($productos.children).find(c => c.querySelector(".name").textContent === p.name);
                        if (card) {
                            const badge = card.querySelector(".business-badge");
                            badge.style.display = "inline-block";
                            badge.title = `Precio negocio: ${formatPrice(bizPrice)}`;
                        }
                    }
                });

                fragment.appendChild(clone);
            }
            $productos.appendChild(fragment);
        }

        // CARRITO
        function addToCart(p) {
            const item = carrito.find(i => i.id === p.id);
            if (item) {
                item.quantity++;
            } else {
                carrito.push({
                    id: p.id,
                    name: p.name,
                    price: parseFloat(p.price),
                    quantity: 1,
                    sku: p.sku
                });
            }
            saveCart();
            renderCart();
        }

        function removeFromCart(id) {
            carrito = carrito.filter(i => i.id !== id);
            saveCart();
            renderCart();
        }

        function updateQty(id, qty) {
            const item = carrito.find(i => i.id === id);
            if (item) {
                item.quantity = parseInt(qty);
                if (item.quantity <= 0) removeFromCart(id);
            }
            saveCart();
            renderCart();
        }

        function clearCart() {
            carrito = [];
            saveCart();
            renderCart();
        }

        function saveCart() {
            localStorage.setItem('carrito', JSON.stringify(carrito));
        }

        function renderCart() {
            $cartItems.innerHTML = "";
            const template = d.getElementById("cart-item-template").content;
            let total = 0;
            let count = 0;

            carrito.forEach(item => {
                const clone = d.importNode(template, true);
                clone.querySelector(".cart-item-name").textContent = item.name.substring(0, 20) + "...";
                clone.querySelector(".cart-item-qty").value = item.quantity;
                clone.querySelector(".cart-item-qty").onchange = (e) => updateQty(item.id, e.target.value);
                clone.querySelector(".cart-item-price").textContent = formatPrice(item.price * item.quantity);
                clone.querySelector(".remove-item").onclick = () => removeFromCart(item.id);
                $cartItems.appendChild(clone);
                total += item.price * item.quantity;
                count += item.quantity;
            });

            $totalPrice.textContent = formatPrice(total);
            $cartCount.textContent = count;
            $cartTotalTop.textContent = formatPrice(total);
        }

        // CHECKOUT
        async function checkout() {
            if (carrito.length === 0) return alert("Carrito vac√≠o");
            
            const btn = d.getElementById("checkout-btn");
            btn.disabled = true;
            btn.textContent = "Registrando...";

            try {
                const order = {
                    payment_method: "bacs",
                    payment_method_title: "POS Mundolavadoras",
                    set_paid: true,
                    line_items: carrito.map(i => ({ product_id: i.id, quantity: i.quantity }))
                };

                const res = await fetch(STORE_MAIN.url.replace('products', 'orders'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Basic ' + btoa(`${STORE_MAIN.key}:${STORE_MAIN.secret}`)
                    },
                    body: JSON.stringify(order)
                });

                if (res.ok) {
                    alert("¬°Venta registrada con √©xito!");
                    printReceipt();
                    clearCart();
                } else {
                    throw new Error("Error en servidor");
                }
            } catch (e) {
                alert("Error al registrar: " + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "PAGAR";
            }
        }

        // IMPRESI√ìN
        function printReceipt() {
            const $body = d.getElementById("receipt-body");
            const $total = d.getElementById("receipt-total");
            const $date = d.getElementById("receipt-date");
            
            $date.textContent = new Date().toLocaleString();
            $body.innerHTML = "";
            let total = 0;

            carrito.forEach(i => {
                const row = `<tr>
                    <td>${i.name.substring(0, 20)}</td>
                    <td align="center">${i.quantity}</td>
                    <td align="right">${formatPrice(i.price * i.quantity)}</td>
                </tr>`;
                $body.insertAdjacentHTML('beforeend', row);
                total += i.price * i.quantity;
            });

            $total.textContent = formatPrice(total);
            window.print();
        }

        // ESC√ÅNER QR
        function initScanner() {
            const reader = d.getElementById("qr-reader");
            if (reader.style.display === "none") {
                reader.style.display = "block";
                html5QrCode = new Html5Qrcode("qr-reader");
                html5QrCode.start(
                    { facingMode: "environment" }, 
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    (text) => {
                        d.getElementById("search").value = text;
                        fetchProducts(text);
                        stopScanner();
                    },
                    (err) => {}
                ).catch(e => alert("Error c√°mara: " + e));
            } else {
                stopScanner();
            }
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    d.getElementById("qr-reader").style.display = "none";
                });
            }
        }

        // EVENTOS
        d.getElementById("search-btn").onclick = () => fetchProducts(d.getElementById("search").value);
        d.getElementById("search").onkeypress = (e) => { if(e.key === "Enter") fetchProducts(e.target.value); };
        d.getElementById("toggle-scanner").onclick = initScanner;
        d.getElementById("checkout-btn").onclick = checkout;
        d.getElementById("print-btn").onclick = printReceipt;
        d.getElementById("cart-toggle").onclick = () => $sidebar.classList.toggle("active");

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }

        // Inicializar
        renderCart();
    </script>
</body>
</html>
