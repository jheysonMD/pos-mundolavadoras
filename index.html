<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#e74c3c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>POS MUNDOLAVADORAS</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary: #e74c3c;
            --primary-dark: #c0392b;
            --secondary: #667eea;
            --success: #2ecc71;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --white: #ffffff;
            --gray-light: #f8f9fa;
            --text-dark: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 10px;
            color: var(--text-dark);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                z-index: 1000;
                max-width: 100% !important;
                height: 60px;
                overflow: hidden;
                transition: height 0.3s ease;
                border-radius: 20px 20px 0 0 !important;
                box-shadow: 0 -10px 30px rgba(0,0,0,0.2) !important;
            }
            .sidebar.active {
                height: 80vh;
                overflow-y: auto;
            }
            .main-content {
                padding-bottom: 70px;
            }
            .cart-toggle {
                display: flex !important;
            }
        }

        .main-content, .sidebar {
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 { font-size: 20px; }
        .header p { font-size: 12px; opacity: 0.9; }

        .search-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .search-box {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 10px;
            margin-bottom: 15px;
        }

        @media (max-width: 600px) {
            .search-box {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .search-box input {
                grid-column: 1;
            }
            
            .btn-group {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                grid-column: 1;
            }
        }

        input[type="search"], input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 16px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        .btn-primary { background: var(--secondary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--primary); }

        .scanner-btn {
            background: #f1c40f;
            color: #000;
        }

        #qr-reader {
            width: 100%;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            padding: 20px;
        }

        .product-card {
            border: 1px solid #eee;
            border-radius: 15px;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .product-card img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .product-card h3 {
            font-size: 14px;
            margin-bottom: 5px;
            height: 40px;
            overflow: hidden;
        }

        .product-price {
            font-weight: bold;
            color: var(--success);
            font-size: 16px;
            margin-bottom: 5px;
        }

        .business-badge {
            background: #f39c12;
            color: white;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 5px;
            display: none;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .business-price {
            background: #27ae60;
            color: white;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 5px;
            display: block;
            margin: 5px 0;
            font-weight: bold;
        }

        .price-selector {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            max-width: 400px;
            width: 90%;
        }

        .price-selector.active {
            display: block;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        .price-option {
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #eee;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .price-option:hover {
            border-color: var(--primary);
            background: var(--gray-light);
        }

        /* Sidebar / Cart Styles */
        .sidebar { padding: 0; display: flex; flex-direction: column; }
        .sidebar-header {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-toggle {
            display: none;
            width: 100%;
            height: 60px;
            background: var(--primary);
            color: white;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }

        #cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 10px;
            align-items: center;
            padding-bottom: 10px;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .cart-item-name { font-size: 12px; font-weight: bold; }
        .cart-item-qty { width: 40px; padding: 5px; border-radius: 5px; border: 1px solid #eee; }
        .cart-item-price { font-size: 12px; }

        .cart-footer {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        /* Loading Spinner */
        .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Receipt Styles - Mejorado para m√≥viles */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            body > *:not(#receipt) { 
                display: none !important;
            }
            
            #receipt { 
                display: block !important;
                visibility: visible !important;
                position: static !important;
                width: 100% !important;
                max-width: 80mm !important;
                margin: 0 !important;
                padding: 5mm !important;
                font-family: 'Courier New', monospace !important;
                font-size: 12px !important;
                color: #000 !important;
                background: #fff !important;
            }
            
            #receipt * { 
                visibility: visible !important;
                color: #000 !important;
            }
            
            #receipt img {
                display: block !important;
                max-width: 100% !important;
                height: auto !important;
            }
            
            #receipt table {
                display: table !important;
                width: 100% !important;
                border-collapse: collapse !important;
            }
            
            #receipt tr {
                display: table-row !important;
            }
            
            #receipt td, #receipt th {
                display: table-cell !important;
                padding: 2px !important;
            }
            
            #receipt div {
                display: block !important;
            }
        }
        
        #receipt { 
            display: none;
            position: fixed;
            top: -9999px;
            left: -9999px;
            background: white;
            color: black;
        }
    </style>
</head>
<body>
    <div class="container">
        <main class="main-content">
            <div class="header">
                <h1>POS MUNDOLAVADORAS</h1>
                <p>Buscador e Inventario en Tiempo Real</p>
            </div>

            <section class="search-section">
                <div class="search-box">
                    <input type="text" id="search-sku" placeholder="üî¢ Buscar por SKU...">
                    <button class="btn btn-primary" id="search-sku-btn">Buscar SKU</button>
                </div>
                <div class="search-box" style="margin-top: 10px;">
                    <input type="text" id="search-name" placeholder="üì¶ Buscar por nombre...">
                    <button class="btn btn-primary" id="search-name-btn">Buscar Nombre</button>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="btn scanner-btn" id="toggle-scanner" style="flex: 1;">üì∑ Escanear QR</button>
                    <button class="btn btn-danger" id="clear-search-btn" style="flex: 1; display: none;">üóëÔ∏è Limpiar</button>
                </div>
                <div id="qr-reader"></div>
                <div id="camera-status"></div>
            </section>

            <div class="loader" id="loader">
                <div class="spinner"></div>
                <p>Buscando...</p>
            </div>

            <section id="productos" class="products-grid">
                <!-- Productos se cargan aqu√≠ -->
            </section>
        </main>

        <aside class="sidebar" id="sidebar">
            <div class="cart-toggle" id="cart-toggle">
                üõí Ver Carrito (<span id="cart-count">0</span>) - <span id="cart-total-top">$0</span>
            </div>
            <div class="sidebar-header">
                <h2>Tu Carrito</h2>
                <button class="btn btn-danger" onclick="clearCart()">Vaciar</button>
            </div>
            <div id="cart-items">
                <!-- Items del carrito -->
            </div>
            <div class="cart-footer">
                <div class="total-row">
                    <span>Total:</span>
                    <span id="total-price">$0</span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" style="flex: 1;" id="checkout-btn">PAGAR</button>
                    <button class="btn btn-primary" id="print-btn">üñ®Ô∏è</button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Ticket Template -->
    <div id="receipt">
        <div style="text-align: center; margin-bottom: 10px;">
            <img src="imagenes/logo.png" style="width: 50mm; filter: grayscale(1);">
            <h3>MUNDOLAVADORAS</h3>
            <p>Calle 10#6-29 sucre</p>
            <p>Tel 3186967164</p>
            <p id="receipt-date"></p>
        </div>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px dashed black;">
                    <th align="left">Prod</th>
                    <th align="center">Cant</th>
                    <th align="right">Total</th>
                </tr>
            </thead>
            <tbody id="receipt-body"></tbody>
        </table>
        <div style="border-top: 1px dashed black; margin-top: 5px; padding-top: 5px;">
            <div style="display: flex; justify-content: space-between; font-weight: bold;">
                <span>TOTAL:</span>
                <span id="receipt-total"></span>
            </div>
        </div>
        <div style="text-align: center; margin-top: 10px; font-size: 10px;">
            <p>Art√≠culos el√©ctricos no tienen garant√≠a</p>
            <p>¬°Gracias por su compra!</p>
        </div>
    </div>

    <template id="producto-template">
        <article class="product-card">
            <img class="image" src="" alt="">
            <div class="business-badge">Precio Negocio</div>
            <h3 class="name"></h3>
            <p class="sku" style="font-size: 11px; color: #95a5a6; margin: 5px 0; font-weight: bold;"></p>
            <p class="product-price"></p>
            <p class="business-price" style="display: none;"></p>
            <p class="stock" style="font-size: 10px; color: #7f8c8d;"></p>
            <button class="btn btn-success add-to-cart" style="width: 100%; margin-top: auto;">Agregar</button>
        </article>
    </template>

    <!-- Price Selector Modal -->
    <div class="overlay" id="overlay"></div>
    <div class="price-selector" id="price-selector">
        <h3 style="margin-bottom: 15px;">Selecciona el precio</h3>
        <div id="price-options"></div>
        <button class="btn btn-danger" onclick="closePriceSelector()" style="width: 100%; margin-top: 10px;">Cancelar</button>
    </div>

    <template id="cart-item-template">
        <div class="cart-item">
            <span class="cart-item-name"></span>
            <input type="number" class="cart-item-qty" min="1">
            <span class="cart-item-price"></span>
            <button class="btn btn-danger remove-item" style="padding: 5px 10px;">x</button>
        </div>
    </template>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        // CONFIGURACIONES
        const STORE_MAIN = {
            url: 'https://mundolavadoras.com/wp-json/wc/v3/products',
            key: 'ck_ac71f77112971d39f3e349dd4a2d0ffbafb21f7a',
            secret: 'cs_fb4fea0b0b698bc83365c2fccb73720003f8da4a'
        };
        const STORE_BIZ = {
            url: 'https://cerebroelectronics.com/wp-json/wc/v3/products',
            key: 'ck_a4223282e3089bd6f9cf0038fc858baf06719436',
            secret: 'cs_8c532ec7decabb40e9a8989bcdcb75ac381f525a'
        };

        const d = document,
            $productos = d.getElementById("productos"),
            $loader = d.getElementById("loader"),
            $cartItems = d.getElementById("cart-items"),
            $totalPrice = d.getElementById("total-price"),
            $cartCount = d.getElementById("cart-count"),
            $cartTotalTop = d.getElementById("cart-total-top"),
            $sidebar = d.getElementById("sidebar");

        let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        let productosCache = [];
        let html5QrCode = null;
        let scannerBuffer = '';
        let scannerTimeout = null;
        let currentProduct = null;
        let searchTimeout = null;

        function formatPrice(number) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(number);
        }

        // FETCH PRODUCTOS - B√∫squeda h√≠brida mejorada para SKUs complejos
        async function fetchProducts(query, acumular = false) {
            $loader.style.display = "block";
            if (!acumular) {
                $productos.innerHTML = "";
            }
            try {
                const lowerQuery = query.toLowerCase();
                const cleanQuery = query.replace(/[^a-zA-Z0-9]/g, ''); // Sin caracteres especiales
                
                // Estrategia m√∫ltiple: buscar de varias formas
                const promises = [
                    // B√∫squeda general por nombre
                    fetch(`${STORE_MAIN.url}?search=${encodeURIComponent(query)}&per_page=100&consumer_key=${STORE_MAIN.key}&consumer_secret=${STORE_MAIN.secret}`),
                    // B√∫squeda por SKU exacto
                    fetch(`${STORE_MAIN.url}?sku=${encodeURIComponent(query)}&consumer_key=${STORE_MAIN.key}&consumer_secret=${STORE_MAIN.secret}`)
                ];
                
                // Si el query tiene guiones, tambi√©n buscar sin ellos
                if (query.includes('-')) {
                    const withoutDash = query.replace(/-/g, '');
                    promises.push(
                        fetch(`${STORE_MAIN.url}?search=${encodeURIComponent(withoutDash)}&per_page=50&consumer_key=${STORE_MAIN.key}&consumer_secret=${STORE_MAIN.secret}`)
                    );
                }
                
                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                // Combinar todos los resultados
                const allProducts = results.flat();
                
                // Eliminar duplicados
                const uniqueProducts = [];
                const seenIds = new Set();
                for (const p of allProducts) {
                    if (!seenIds.has(p.id)) {
                        seenIds.add(p.id);
                        uniqueProducts.push(p);
                    }
                }

                // Filtrado avanzado: buscar en SKU incluso con guiones
                const filteredProducts = uniqueProducts.filter(p => {
                    const name = (p.name || '').toLowerCase();
                    const sku = (p.sku || '').toLowerCase();
                    const skuClean = sku.replace(/[^a-z0-9]/g, ''); // SKU sin caracteres especiales
                    
                    // Coincide si:
                    // 1. Est√° en el nombre
                    // 2. Est√° en el SKU original
                    // 3. Est√° en el SKU sin caracteres especiales
                    // 4. El SKU limpio contiene el query limpio
                    return name.includes(lowerQuery) || 
                           sku.includes(lowerQuery) ||
                           sku.includes(cleanQuery) ||
                           skuClean.includes(cleanQuery);
                });

                // Ordenamiento por relevancia
                filteredProducts.sort((a, b) => {
                    const aSku = (a.sku || '').toLowerCase();
                    const bSku = (b.sku || '').toLowerCase();
                    const aSkuClean = aSku.replace(/[^a-z0-9]/g, '');
                    const bSkuClean = bSku.replace(/[^a-z0-9]/g, '');
                    const aName = (a.name || '').toLowerCase();
                    const bName = (b.name || '').toLowerCase();
                    
                    // 1. SKU exacto (con o sin guiones)
                    if ((aSku === lowerQuery || aSkuClean === cleanQuery) && 
                        (bSku !== lowerQuery && bSkuClean !== cleanQuery)) return -1;
                    if ((bSku === lowerQuery || bSkuClean === cleanQuery) && 
                        (aSku !== lowerQuery && aSkuClean !== cleanQuery)) return 1;
                    
                    // 2. SKU que empieza con la b√∫squeda
                    if ((aSku.startsWith(lowerQuery) || aSkuClean.startsWith(cleanQuery)) && 
                        (!bSku.startsWith(lowerQuery) && !bSkuClean.startsWith(cleanQuery))) return -1;
                    if ((bSku.startsWith(lowerQuery) || bSkuClean.startsWith(cleanQuery)) && 
                        (!aSku.startsWith(lowerQuery) && !aSkuClean.startsWith(cleanQuery))) return 1;
                    
                    // 3. SKU que contiene la b√∫squeda
                    if ((aSku.includes(lowerQuery) || aSkuClean.includes(cleanQuery)) && 
                        (!bSku.includes(lowerQuery) && !bSkuClean.includes(cleanQuery))) return -1;
                    if ((bSku.includes(lowerQuery) || bSkuClean.includes(cleanQuery)) && 
                        (!aSku.includes(lowerQuery) && !aSkuClean.includes(cleanQuery))) return 1;
                    
                    // 4. Nombre que empieza con la b√∫squeda
                    if (aName.startsWith(lowerQuery) && !bName.startsWith(lowerQuery)) return -1;
                    if (bName.startsWith(lowerQuery) && !aName.startsWith(lowerQuery)) return 1;
                    
                    return 0;
                });

                // Si acumulamos, agregar sin duplicar
                if (acumular) {
                    filteredProducts.forEach(p => {
                        if (!productosCache.find(cached => cached.id === p.id)) {
                            productosCache.push(p);
                        }
                    });
                } else {
                    productosCache = filteredProducts;
                }
                
                renderProducts(filteredProducts, acumular);
                
                // Mostrar mensaje si no hay productos
                if (productosCache.length === 0 && !acumular) {
                    $productos.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                            <h3 style="color: #7f8c8d; font-size: 18px;">üòï No se encontraron productos</h3>
                            <p style="color: #95a5a6; margin-top: 10px;">Intenta con otro t√©rmino de b√∫squeda</p>
                        </div>
                    `;
                }
                
                // Mostrar bot√≥n limpiar
                const clearBtn = d.getElementById("clear-search-btn");
                clearBtn.style.display = productosCache.length > 0 ? "block" : "none";
            } catch (err) {
                console.error(err);
                if (!acumular) {
                    $productos.innerHTML = "<h3>Error al cargar productos</h3>";
                }
            } finally {
                $loader.style.display = "none";
            }
        }

        // B√∫squeda de SKU EXACTO para esc√°neres (solo trae el producto exacto)
        async function searchExactSKU(sku, acumular = true) {
            $loader.style.display = "block";
            try {
                // Buscar SOLO por SKU exacto
                const api = `${STORE_MAIN.url}?sku=${encodeURIComponent(sku)}&consumer_key=${STORE_MAIN.key}&consumer_secret=${STORE_MAIN.secret}`;
                const res = await fetch(api);
                const products = await res.json();

                // Si acumulamos, agregar sin duplicar
                if (acumular) {
                    products.forEach(p => {
                        if (!productosCache.find(cached => cached.id === p.id)) {
                            productosCache.push(p);
                        }
                    });
                } else {
                    productosCache = products;
                }
                
                renderProducts(products, acumular);
                
                // Mostrar mensaje si no hay productos
                if (products.length === 0) {
                    alert(`No se encontr√≥ producto con SKU: ${sku}`);
                }
                
                // Mostrar bot√≥n limpiar
                const clearBtn = d.getElementById("clear-search-btn");
                clearBtn.style.display = productosCache.length > 0 ? "block" : "none";
            } catch (err) {
                console.error(err);
                alert("Error al buscar: " + err.message);
            } finally {
                $loader.style.display = "none";
            }
        }

        // B√∫squeda espec√≠fica por SKU con coincidencias parciales mejorada
        async function searchBySKU(sku, acumular = true) {
            $loader.style.display = "block";
            if (!acumular) {
                $productos.innerHTML = "";
            }
            try {
                const lowerQuery = sku.toLowerCase();
                const cleanQuery = sku.replace(/[^a-zA-Z0-9]/g, '');
                
                // Estrategia agresiva: obtener MUCHOS productos para filtrar localmente
                const promises = [
                    // SKU exacto
                    fetch(`${STORE_MAIN.url}?sku=${encodeURIComponent(sku)}&consumer_key=${STORE_MAIN.key}&consumer_secret=${STORE_MAIN.secret}`),
                    // B√∫squeda general amplia
                    fetch(`${STORE_MAIN.url}?per_page=100&consumer_key=${STORE_MAIN.key}&consumer_secret=${STORE_MAIN.secret}`),
                    // B√∫squeda por el t√©rmino
                    fetch(`${STORE_MAIN.url}?search=${encodeURIComponent(sku)}&per_page=100&consumer_key=${STORE_MAIN.key}&consumer_secret=${STORE_MAIN.secret}`)
                ];
                
                // Buscar por partes del SKU
                const skuParts = sku.split(/[-]/);
                for (const part of skuParts) {
                    if (part.length >= 2) {
                        promises.push(
                            fetch(`${STORE_MAIN.url}?search=${encodeURIComponent(part)}&per_page=50&consumer_key=${STORE_MAIN.key}&consumer_secret=${STORE_MAIN.secret}`)
                        );
                    }
                }
                
                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                // Combinar resultados
                const allProducts = results.flat();
                
                // Eliminar duplicados
                const uniqueProducts = [];
                const seenIds = new Set();
                for (const p of allProducts) {
                    if (!seenIds.has(p.id)) {
                        seenIds.add(p.id);
                        uniqueProducts.push(p);
                    }
                }
                
                // Filtrar localmente - SOLO productos que contengan la b√∫squeda en el SKU
                const skuProducts = uniqueProducts.filter(p => {
                    const productSku = (p.sku || '').toLowerCase();
                    const productSkuClean = productSku.replace(/[^a-z0-9]/g, '');
                    
                    // Verificar si contiene la b√∫squeda
                    return productSku.includes(lowerQuery) || 
                           productSku.includes(cleanQuery) ||
                           productSkuClean.includes(cleanQuery) ||
                           // Verificar cada parte del SKU
                           skuParts.some(part => productSku.includes(part.toLowerCase()));
                });
                
                // Ordenar por relevancia
                skuProducts.sort((a, b) => {
                    const aSku = (a.sku || '').toLowerCase();
                    const bSku = (b.sku || '').toLowerCase();
                    const aSkuClean = aSku.replace(/[^a-z0-9]/g, '');
                    const bSkuClean = bSku.replace(/[^a-z0-9]/g, '');
                    
                    // SKU exacto primero
                    if ((aSku === lowerQuery || aSkuClean === cleanQuery) && 
                        (bSku !== lowerQuery && bSkuClean !== cleanQuery)) return -1;
                    if ((bSku === lowerQuery || bSkuClean === cleanQuery) && 
                        (aSku !== lowerQuery && aSkuClean !== cleanQuery)) return 1;
                    
                    // SKU que empieza con la b√∫squeda
                    if ((aSku.startsWith(lowerQuery) || aSkuClean.startsWith(cleanQuery)) && 
                        (!bSku.startsWith(lowerQuery) && !bSkuClean.startsWith(cleanQuery))) return -1;
                    if ((bSku.startsWith(lowerQuery) || bSkuClean.startsWith(cleanQuery)) && 
                        (!aSku.startsWith(lowerQuery) && !aSkuClean.startsWith(cleanQuery))) return 1;
                    
                    return 0;
                });

                // Si acumulamos, agregar sin duplicar
                if (acumular) {
                    skuProducts.forEach(p => {
                        if (!productosCache.find(cached => cached.id === p.id)) {
                            productosCache.push(p);
                        }
                    });
                } else {
                    productosCache = skuProducts;
                }
                
                renderProducts(skuProducts, acumular);
                
                // Mostrar mensaje si no hay productos
                if (skuProducts.length === 0) {
                    if (!acumular || productosCache.length === 0) {
                        $productos.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                                <h3 style="color: #7f8c8d; font-size: 18px;">üòï No se encontraron productos con SKU que contengan "${sku}"</h3>
                                <p style="color: #95a5a6; margin-top: 10px;">Intenta con m√°s caracteres del SKU</p>
                            </div>
                        `;
                    }
                }
                
                // Mostrar bot√≥n limpiar
                const clearBtn = d.getElementById("clear-search-btn");
                clearBtn.style.display = productosCache.length > 0 ? "block" : "none";
            } catch (err) {
                console.error(err);
                alert("Error al buscar por SKU: " + err.message);
            } finally {
                $loader.style.display = "none";
            }
        }

        // B√∫squeda espec√≠fica por nombre con filtrado y ordenamiento mejorado
        async function searchByName(name, acumular = true) {
            $loader.style.display = "block";
            if (!acumular) {
                $productos.innerHTML = "";
            }
            try {
                const lowerQuery = name.toLowerCase();
                
                // Buscar por nombre
                const api = `${STORE_MAIN.url}?search=${encodeURIComponent(name)}&per_page=100&consumer_key=${STORE_MAIN.key}&consumer_secret=${STORE_MAIN.secret}`;
                const res = await fetch(api);
                let products = await res.json();

                // FILTRAR: Solo productos que contengan el t√©rmino en el nombre
                products = products.filter(p => {
                    const productName = (p.name || '').toLowerCase();
                    return productName.includes(lowerQuery);
                });

                // ORDENAR por relevancia
                products.sort((a, b) => {
                    const aName = (a.name || '').toLowerCase();
                    const bName = (b.name || '').toLowerCase();
                    
                    // 1. Productos cuyo nombre EMPIEZA con el t√©rmino van primero
                    const aStarts = aName.startsWith(lowerQuery);
                    const bStarts = bName.startsWith(lowerQuery);
                    if (aStarts && !bStarts) return -1;
                    if (!aStarts && bStarts) return 1;
                    
                    // 2. Si ambos empiezan (o ninguno), ordenar por posici√≥n del t√©rmino
                    const aIndex = aName.indexOf(lowerQuery);
                    const bIndex = bName.indexOf(lowerQuery);
                    if (aIndex !== bIndex) return aIndex - bIndex;
                    
                    // 3. Si est√°n en la misma posici√≥n, ordenar alfab√©ticamente
                    return aName.localeCompare(bName);
                });

                // Si acumulamos, agregar sin duplicar
                if (acumular) {
                    products.forEach(p => {
                        if (!productosCache.find(cached => cached.id === p.id)) {
                            productosCache.push(p);
                        }
                    });
                } else {
                    productosCache = products;
                }
                
                renderProducts(products, acumular);
                
                // Mostrar mensaje si no hay productos
                if (products.length === 0) {
                    if (!acumular || productosCache.length === 0) {
                        $productos.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                                <h3 style="color: #7f8c8d; font-size: 18px;">üòï No se encontraron productos con "${name}"</h3>
                                <p style="color: #95a5a6; margin-top: 10px;">Intenta con otro t√©rmino</p>
                            </div>
                        `;
                    }
                }
                
                // Mostrar bot√≥n limpiar
                const clearBtn = d.getElementById("clear-search-btn");
                clearBtn.style.display = productosCache.length > 0 ? "block" : "none";
            } catch (err) {
                console.error(err);
                alert("Error al buscar por nombre: " + err.message);
            } finally {
                $loader.style.display = "none";
            }
        }

        function clearSearch() {
            $productos.innerHTML = "";
            productosCache = [];
            d.getElementById("search-sku").value = "";
            d.getElementById("search-name").value = "";
            d.getElementById("clear-search-btn").style.display = "none";
        }

        async function getBusinessPrice(sku) {
            try {
                const api = `${STORE_BIZ.url}?sku=${encodeURIComponent(sku)}&consumer_key=${STORE_BIZ.key}&consumer_secret=${STORE_BIZ.secret}`;
                const res = await fetch(api);
                const products = await res.json();
                if (products.length > 0) {
                    const p = products[0];
                    let bizPrice = null;
                    if (p.meta_data) {
                        const meta = p.meta_data.find(m => m.key === '_precio_cliente_negocio');
                        if (meta) bizPrice = parseFloat(meta.value);
                    }
                    return bizPrice || parseFloat(p.price);
                }
            } catch (e) { return null; }
            return null;
        }

        async function renderProducts(products, acumular = false) {
            const template = d.getElementById("producto-template").content;

            // Renderizar cada producto inmediatamente y buscar precio de negocio despu√©s
            for (const p of products) {
                // Evitar duplicados si estamos acumulando
                if (acumular && Array.from($productos.children).find(child => child.dataset.productId === String(p.id))) {
                    continue;
                }
                
                const clone = d.importNode(template, true);
                const card = clone.querySelector(".product-card");
                card.dataset.productId = p.id;
                
                clone.querySelector(".name").textContent = p.name;
                clone.querySelector(".sku").textContent = `SKU: ${p.sku || 'N/A'}`;
                clone.querySelector(".product-price").textContent = formatPrice(parseFloat(p.price));
                clone.querySelector(".stock").textContent = `Stock: ${p.stock_quantity || 0}`;
                clone.querySelector(".image").src = p.images.length ? p.images[0].src : 'imagenes/logo.png';
                
                const addBtn = clone.querySelector(".add-to-cart");
                
                // Bot√≥n por defecto (precio normal)
                addBtn.onclick = () => addToCart(p, parseFloat(p.price));
                
                // Agregar al DOM INMEDIATAMENTE
                $productos.appendChild(clone);
                
                // Buscar precio de negocio EN SEGUNDO PLANO (no bloquea)
                getBusinessPrice(p.sku).then(bizPrice => {
                    if (bizPrice && bizPrice < parseFloat(p.price)) {
                        // Encontrar la tarjeta ya renderizada
                        const renderedCard = Array.from($productos.children).find(
                            child => child.dataset.productId === String(p.id)
                        );
                        
                        if (renderedCard) {
                            // Actualizar con precio de negocio
                            const bizPriceEl = renderedCard.querySelector(".business-price");
                            bizPriceEl.textContent = `Negocio: ${formatPrice(bizPrice)}`;
                            bizPriceEl.style.display = "block";
                            
                            // Guardar ambos precios en el producto
                            p.businessPrice = bizPrice;
                            
                            // Actualizar bot√≥n
                            const btn = renderedCard.querySelector(".add-to-cart");
                            btn.onclick = () => showPriceSelector(p);
                        }
                    }
                });
            }
        }

        // SELECTOR DE PRECIO
        function showPriceSelector(product) {
            currentProduct = product;
            const selector = d.getElementById("price-selector");
            const overlay = d.getElementById("overlay");
            const options = d.getElementById("price-options");
            
            options.innerHTML = `
                <div class="price-option" onclick="addToCart(currentProduct, ${parseFloat(product.price)})">
                    <strong>Precio Normal</strong>
                    <div style="font-size: 18px; color: var(--success); margin-top: 5px;">
                        ${formatPrice(parseFloat(product.price))}
                    </div>
                </div>
                <div class="price-option" onclick="addToCart(currentProduct, ${product.businessPrice})">
                    <strong>Precio Negocio</strong>
                    <div style="font-size: 18px; color: #27ae60; margin-top: 5px;">
                        ${formatPrice(product.businessPrice)}
                    </div>
                </div>
            `;
            
            selector.classList.add("active");
            overlay.classList.add("active");
        }

        function closePriceSelector() {
            d.getElementById("price-selector").classList.remove("active");
            d.getElementById("overlay").classList.remove("active");
            currentProduct = null;
        }

        // CARRITO
        function addToCart(p, selectedPrice) {
            const price = selectedPrice || parseFloat(p.price);
            const item = carrito.find(i => i.id === p.id && i.price === price);
            
            // Marcar si el producto existe en ambas tiendas (tiene businessPrice)
            const existsInBothStores = p.businessPrice !== null && p.businessPrice !== undefined;
            
            if (item) {
                item.quantity++;
            } else {
                carrito.push({
                    id: p.id,
                    name: p.name,
                    price: price,
                    quantity: 1,
                    sku: p.sku,
                    existsInBothStores: existsInBothStores // Marcar si est√° en ambas tiendas
                });
            }
            saveCart();
            renderCart();
            closePriceSelector();
        }

        function removeFromCart(id) {
            carrito = carrito.filter(i => i.id !== id);
            saveCart();
            renderCart();
        }

        function updateQty(id, qty) {
            const item = carrito.find(i => i.id === id);
            if (item) {
                item.quantity = parseInt(qty);
                if (item.quantity <= 0) removeFromCart(id);
            }
            saveCart();
            renderCart();
        }

        function clearCart() {
            carrito = [];
            saveCart();
            renderCart();
        }

        function saveCart() {
            localStorage.setItem('carrito', JSON.stringify(carrito));
        }

        function renderCart() {
            $cartItems.innerHTML = "";
            const template = d.getElementById("cart-item-template").content;
            let total = 0;
            let count = 0;

            carrito.forEach(item => {
                const clone = d.importNode(template, true);
                clone.querySelector(".cart-item-name").textContent = item.name.substring(0, 20) + "...";
                clone.querySelector(".cart-item-qty").value = item.quantity;
                clone.querySelector(".cart-item-qty").onchange = (e) => updateQty(item.id, e.target.value);
                clone.querySelector(".cart-item-price").textContent = formatPrice(item.price * item.quantity);
                clone.querySelector(".remove-item").onclick = () => removeFromCart(item.id);
                $cartItems.appendChild(clone);
                total += item.price * item.quantity;
                count += item.quantity;
            });

            $totalPrice.textContent = formatPrice(total);
            $cartCount.textContent = count;
            $cartTotalTop.textContent = formatPrice(total);
        }

        // CHECKOUT
        async function checkout() {
            if (carrito.length === 0) return alert("Carrito vac√≠o");
            
            const btn = d.getElementById("checkout-btn");
            btn.disabled = true;
            btn.textContent = "Registrando...";

            try {
                // Separar productos que existen en ambas tiendas
                const itemsEnAmbasTiendas = carrito.filter(i => i.existsInBothStores);
                
                const promises = [];
                
                // SIEMPRE registrar venta en tienda principal (Mundolavadoras)
                if (carrito.length > 0) {
                    const order = {
                        payment_method: "bacs",
                        payment_method_title: "POS Mundolavadoras",
                        set_paid: true,
                        line_items: carrito.map(i => ({ product_id: i.id, quantity: i.quantity }))
                    };

                    const orderUrl = STORE_MAIN.url.replace('products', 'orders');
                    promises.push(
                        fetch(orderUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Basic ' + btoa(`${STORE_MAIN.key}:${STORE_MAIN.secret}`)
                            },
                            body: JSON.stringify(order)
                        })
                    );
                }
                
                // Si hay productos que existen en ambas tiendas, TAMBI√âN descontar de tienda secundaria
                if (itemsEnAmbasTiendas.length > 0) {
                    console.log("üîÑ Productos en ambas tiendas:", itemsEnAmbasTiendas);
                    
                    // Buscar los IDs de los productos en la tienda de negocio por SKU
                    const bizPromises = itemsEnAmbasTiendas.map(async item => {
                        try {
                            console.log(`üîç Buscando SKU "${item.sku}" en tienda negocio...`);
                            const api = `${STORE_BIZ.url}?sku=${encodeURIComponent(item.sku)}&consumer_key=${STORE_BIZ.key}&consumer_secret=${STORE_BIZ.secret}`;
                            const res = await fetch(api);
                            const products = await res.json();
                            console.log(`üì¶ Productos encontrados para SKU "${item.sku}":`, products);
                            if (products.length > 0) {
                                console.log(`‚úÖ Producto encontrado - ID: ${products[0].id}, Cantidad: ${item.quantity}`);
                                return {
                                    product_id: products[0].id,
                                    quantity: item.quantity
                                };
                            } else {
                                console.warn(`‚ö†Ô∏è No se encontr√≥ producto con SKU "${item.sku}" en tienda negocio`);
                            }
                        } catch (e) {
                            console.error("‚ùå Error buscando producto en tienda negocio:", e);
                        }
                        return null;
                    });
                    
                    const bizLineItems = (await Promise.all(bizPromises)).filter(item => item !== null);
                    console.log("üìã Items para orden de tienda negocio:", bizLineItems);
                    
                    if (bizLineItems.length > 0) {
                        const bizOrder = {
                            payment_method: "bacs",
                            payment_method_title: "POS Mundolavadoras (Sincronizaci√≥n inventario)",
                            set_paid: true,
                            line_items: bizLineItems
                        };
                        
                        console.log("üìù Creando orden en tienda negocio:", bizOrder);
                        const bizOrderUrl = STORE_BIZ.url.replace('products', 'orders');
                        promises.push(
                            fetch(bizOrderUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Basic ' + btoa(`${STORE_BIZ.key}:${STORE_BIZ.secret}`)
                                },
                                body: JSON.stringify(bizOrder)
                            })
                        );
                    } else {
                        console.warn("‚ö†Ô∏è No hay items para crear orden en tienda negocio");
                    }
                }

                const results = await Promise.all(promises);
                const allOk = results.every(r => r.ok);
                
                if (allOk) {
                    let message = "¬°Venta registrada con √©xito!";
                    if (itemsEnAmbasTiendas.length > 0) {
                        message += `\n\n‚úÖ Inventario actualizado en AMBAS tiendas (${itemsEnAmbasTiendas.length} productos compartidos)`;
                    }
                    alert(message);
                    printReceipt();
                    clearCart();
                } else {
                    throw new Error("Error al registrar en una o ambas tiendas");
                }
            } catch (e) {
                alert("Error al registrar: " + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "PAGAR";
            }
        }

        // IMPRESI√ìN
        function printReceipt() {
            const $body = d.getElementById("receipt-body");
            const $total = d.getElementById("receipt-total");
            const $date = d.getElementById("receipt-date");
            
            $date.textContent = new Date().toLocaleString();
            $body.innerHTML = "";
            let total = 0;

            carrito.forEach(i => {
                const row = `<tr>
                    <td>${i.name.substring(0, 20)}</td>
                    <td align="center">${i.quantity}</td>
                    <td align="right">${formatPrice(i.price * i.quantity)}</td>
                </tr>`;
                $body.insertAdjacentHTML('beforeend', row);
                total += i.price * i.quantity;
            });

            $total.textContent = formatPrice(total);
            window.print();
        }

        // ESC√ÅNER QR
        async function initScanner() {
            const reader = d.getElementById("qr-reader");
            const statusDiv = d.getElementById("camera-status");
            const scanBtn = d.getElementById("toggle-scanner");
            
            if (reader.style.display === "none" || reader.style.display === "") {
                try {
                    // Verificar HTTPS
                    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                        alert("‚ö†Ô∏è La c√°mara solo funciona con HTTPS.\n\nAseg√∫rate de que tu sitio cargue con https:// (candado üîí)");
                        return;
                    }

                    statusDiv.innerHTML = '<p style="color: #3498db; padding: 10px;">üì∑ Iniciando c√°mara...</p>';
                    reader.style.display = "block";
                    scanBtn.textContent = "‚ùå Cerrar";
                    scanBtn.style.background = "#e74c3c";

                    html5QrCode = new Html5Qrcode("qr-reader");
                    
                    await html5QrCode.start(
                        { facingMode: "environment" }, 
                        { 
                            fps: 10, 
                            qrbox: { width: 250, height: 250 },
                            aspectRatio: 1.0
                        },
                        (decodedText) => {
                            statusDiv.innerHTML = '<p style="color: #27ae60; padding: 10px;">‚úÖ C√≥digo detectado!</p>';
                            // Usar el campo de SKU para mostrar el c√≥digo
                            d.getElementById("search-sku").value = decodedText;
                            // Buscar SOLO el producto exacto
                            searchExactSKU(decodedText, true); // B√∫squeda exacta
                            stopScanner();
                        },
                        (errorMessage) => {
                            // Errores de escaneo continuo - ignorar
                        }
                    );
                    
                    statusDiv.innerHTML = '<p style="color: #27ae60; padding: 10px;">‚úÖ C√°mara activa. Enfoca un c√≥digo QR</p>';
                    
                } catch (err) {
                    console.error("Error al iniciar esc√°ner:", err);
                    reader.style.display = "none";
                    scanBtn.textContent = "üì∑ Escanear";
                    scanBtn.style.background = "#f1c40f";
                    
                    let errorMsg = "Error al acceder a la c√°mara";
                    
                    if (err.name === 'NotAllowedError' || (err.message && err.message.includes('permission'))) {
                        errorMsg = "‚ùå Permiso denegado.\n\nVe a configuraci√≥n del navegador y permite el acceso a la c√°mara.";
                    } else if (err.name === 'NotFoundError') {
                        errorMsg = "‚ùå No se encontr√≥ ninguna c√°mara en el dispositivo.";
                    } else if (err.name === 'NotReadableError') {
                        errorMsg = "‚ùå La c√°mara est√° siendo usada por otra aplicaci√≥n.";
                    } else if (err.message) {
                        errorMsg = `‚ùå Error: ${err.message}`;
                    }
                    
                    statusDiv.innerHTML = `<p style="color: #e74c3c; padding: 10px;">${errorMsg.replace(/\n/g, '<br>')}</p>`;
                    alert(errorMsg);
                }
            } else {
                stopScanner();
            }
        }

        function stopScanner() {
            const reader = d.getElementById("qr-reader");
            const statusDiv = d.getElementById("camera-status");
            const scanBtn = d.getElementById("toggle-scanner");
            
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    reader.style.display = "none";
                    statusDiv.innerHTML = "";
                    scanBtn.textContent = "üì∑ Escanear";
                    scanBtn.style.background = "#f1c40f";
                    scanBtn.style.color = "#000";
                    html5QrCode = null;
                }).catch(err => {
                    console.error("Error al detener esc√°ner:", err);
                    reader.style.display = "none";
                    statusDiv.innerHTML = "";
                    scanBtn.textContent = "üì∑ Escanear";
                    scanBtn.style.background = "#f1c40f";
                    scanBtn.style.color = "#000";
                });
            }
        }

        // ESC√ÅNER F√çSICO DE C√ìDIGO DE BARRAS (USB)
        d.addEventListener('keypress', (e) => {
            // Ignorar si estamos escribiendo en un input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // El esc√°ner f√≠sico env√≠a los caracteres r√°pidamente y termina con Enter
            clearTimeout(scannerTimeout);
            
            if (e.key === 'Enter') {
                if (scannerBuffer.length > 3) { // C√≥digos de barras suelen tener m√°s de 3 caracteres
                    d.getElementById("search-sku").value = scannerBuffer;
                    searchExactSKU(scannerBuffer, true); // B√∫squeda exacta para esc√°ner
                    scannerBuffer = '';
                }
            } else {
                scannerBuffer += e.key;
                scannerTimeout = setTimeout(() => {
                    scannerBuffer = ''; // Limpiar buffer si pasa mucho tiempo
                }, 100);
            }
        });

        // EVENTOS
        d.getElementById("search-sku-btn").onclick = () => {
            const sku = d.getElementById("search-sku").value.trim();
            if (sku.length > 0) {
                searchBySKU(sku, true); // true = acumular
            }
        };
        d.getElementById("search-sku").onkeypress = (e) => { 
            if(e.key === "Enter") {
                const sku = e.target.value.trim();
                if (sku.length > 0) {
                    searchBySKU(sku, true);
                }
            }
        };
        
        d.getElementById("search-name-btn").onclick = () => {
            const name = d.getElementById("search-name").value.trim();
            if (name.length > 0) {
                searchByName(name, true); // true = acumular
            }
        };
        d.getElementById("search-name").onkeypress = (e) => { 
            if(e.key === "Enter") {
                const name = e.target.value.trim();
                if (name.length > 0) {
                    searchByName(name, true);
                }
            }
        };
        
        d.getElementById("toggle-scanner").onclick = initScanner;
        d.getElementById("clear-search-btn").onclick = clearSearch;
        d.getElementById("checkout-btn").onclick = checkout;
        d.getElementById("print-btn").onclick = printReceipt;
        d.getElementById("cart-toggle").onclick = () => $sidebar.classList.toggle("active");
        d.getElementById("overlay").onclick = closePriceSelector;

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }

        // Inicializar
        renderCart();
    </script>
</body>
</html>
